---
title: "ETC5242 Assignment 2"
author: "Jyovika Aswale, Siddhi Jadhav, Sia Chawla"
format: html
editor: visual
---

```{r}
#| label: setup
#| include: false
#| echo: false
#| message: false
#| warning: false

knitr::opts_chunk$set(fig.align = "center", fig.width = 8, fig.height = 5, dpi = 150)

library(tidyverse)
library(boot)
library(MASS)

set.seed(355435)  

B <- 5000
```

```{r}
pedestrian_df <- read.csv(here::here("data/pedestrians.csv"))
```

```{r, EDA_plots}
pedestrian_long <- pedestrian_df %>%
  mutate(obs = row_number()) %>%
  pivot_longer(-obs, names_to = "crossing", values_to = "count") %>%
  mutate(crossing = factor(crossing,
                           levels = c("southern_cross","flinders_street","qv_melbourne")))

# Box + jitter (great manager slide)
ggplot(pedestrian_long, aes(x = crossing, y = count, fill = crossing)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  geom_jitter(width = 0.15, alpha = 0.5, size = 1.6) +
  labs(title = "Pedestrian counts by crossing", x = NULL, y = "Count per interval") +
  theme_minimal() + theme(legend.position = "none")

# Density (shape of distributions)
ggplot(pedestrian_long, aes(x = count, fill = crossing)) +
  geom_density(alpha = 0.35) +
  facet_wrap(~ crossing, scales = "fixed") +
  labs(title = "Distribution (density) per crossing", x = "Count", y = "Density") +
  theme_minimal()

```

```{r, EDA_summaries}
desc <- pedestrian_long |>
  group_by(crossing) |>
  summarise(
    n     = n(),
    mean  = mean(count),
    median= median(count),
    sd    = sd(count),
    min   = min(count),
    max   = max(count),
    iqr   = IQR(count),
    .groups = "drop"
)

```

## task 1

```{r, MLE}
# Southern Cross
sc <- pedestrian_df$southern_cross
fit_sc_norm <- fitdistr(sc, "normal")
fit_sc_logn <- fitdistr(sc, "lognormal")
sc_models <- tibble(
  crossing = "southern_cross",
  model    = c("normal","lognormal"),
  logLik   = c(logLik(fit_sc_norm)[1], logLik(fit_sc_logn)[1]),
  
  mean_est = c(
    unname(fit_sc_norm$estimate["mean"]),
    exp(fit_sc_logn$estimate["meanlog"] + 0.5*fit_sc_logn$estimate["sdlog"]^2)),
  
  sd_est   = c(
    unname(fit_sc_norm$estimate["sd"]),
    sqrt((exp(fit_sc_logn$estimate["sdlog"]^2) - 1) *
         exp(2*fit_sc_logn$estimate["meanlog"] + fit_sc_logn$estimate["sdlog"]^2))))

# Flinders Street
fl <- pedestrian_df$flinders_street
fit_fl_norm <- fitdistr(fl, "normal")
fit_fl_logn <- fitdistr(fl, "lognormal")
fl_models <- tibble(
  crossing = "flinders_street",
  model    = c("normal","lognormal"),
  logLik   = c(logLik(fit_fl_norm)[1], logLik(fit_fl_logn)[1]),
  
  mean_est = c(
    unname(fit_fl_norm$estimate["mean"]),
    exp(fit_fl_logn$estimate["meanlog"] + 0.5*fit_fl_logn$estimate["sdlog"]^2)),
  
  sd_est   = c(
    unname(fit_fl_norm$estimate["sd"]),
    sqrt((exp(fit_fl_logn$estimate["sdlog"]^2) - 1) *
         exp(2*fit_fl_logn$estimate["meanlog"] + fit_fl_logn$estimate["sdlog"]^2))))

# QV Melbourne
qv <- pedestrian_df$qv_melbourne
fit_qv_norm <- fitdistr(qv, "normal")
fit_qv_logn <- fitdistr(qv, "lognormal")
qv_models <- tibble::tibble(
  crossing = "qv_melbourne",
  model    = c("normal","lognormal"),
  logLik   = c(logLik(fit_qv_norm)[1], logLik(fit_qv_logn)[1]),
  
  mean_est = c(
    unname(fit_qv_norm$estimate["mean"]),
    exp(fit_qv_logn$estimate["meanlog"] + 0.5*fit_qv_logn$estimate["sdlog"]^2)),
  
  sd_est   = c(
    unname(fit_qv_norm$estimate["sd"]),
    sqrt((exp(fit_qv_logn$estimate["sdlog"]^2) - 1) *
         exp(2*fit_qv_logn$estimate["meanlog"] + fit_qv_logn$estimate["sdlog"]^2))))

mle_fits <- bind_rows(sc_models, fl_models, qv_models) |>
  arrange(crossing, desc(logLik))

mle_fits
```

```{r}
par(mfrow = c(1,2))

# Southern Cross
qqnorm((sc - fit_sc_norm$estimate["mean"])/fit_sc_norm$estimate["sd"],
       main="Southern Cross: QQ vs Normal"); abline(0,1)
qqnorm((log(sc) - fit_sc_logn$estimate["meanlog"])/fit_sc_logn$estimate["sdlog"],
       main="Southern Cross: QQ of log(count)"); abline(0,1)

## Flinders
qqnorm((fl - fit_fl_norm$estimate["mean"]) / fit_fl_norm$estimate["sd"],
       main = "Flinders: QQ vs Normal"); abline(0, 1)

qqnorm((log(fl) - fit_fl_logn$estimate["meanlog"]) / fit_fl_logn$estimate["sdlog"],
       main = "Flinders: QQ of log(count)"); abline(0, 1)


## QV
qqnorm((qv - fit_qv_norm$estimate["mean"]) / fit_qv_norm$estimate["sd"],
       main = "QV: QQ vs Normal"); abline(0, 1)

qqnorm((log(qv) - fit_qv_logn$estimate["meanlog"]) / fit_qv_logn$estimate["sdlog"],
       main = "QV: QQ of log(count)"); abline(0, 1)


```

```{r}
fit_sc_nb <- fitdistr(sc, "Negative Binomial")
fit_fl_nb <- fitdistr(fl, "Negative Binomial")
fit_qv_nb <- fitdistr(qv, "Negative Binomial")

qq_nb <- function(x, size, mu, main = "QQ vs Negative Binomial"){
  n  <- length(x)
  xs <- sort(x)
  p  <- (seq_len(n) - 0.5) / n
  qt <- qnbinom(p, size = size, mu = mu)
  plot(qt, xs, xlab = "Theoretical quantiles (NB)",
       ylab = "Sample quantiles", main = main)
  abline(0, 1)
}

par(mfrow = c(1,3))
qq_nb(sc, fit_sc_nb$estimate["size"], fit_sc_nb$estimate["mu"], "SC: QQ vs NB")
qq_nb(fl, fit_fl_nb$estimate["size"], fit_fl_nb$estimate["mu"], "FL: QQ vs NB")
qq_nb(qv, fit_qv_nb$estimate["size"], fit_qv_nb$estimate["mu"], "QV: QQ vs NB")
par(mfrow = c(1,1))

```

```{r, t.test&bootstrap}

t.test(pedestrian_df$qv_melbourne, pedestrian_df$southern_cross,  paired = TRUE)  # QV - SC
t.test(pedestrian_df$qv_melbourne, pedestrian_df$flinders_street, paired = TRUE)  # QV - FL
t.test(pedestrian_df$southern_cross, pedestrian_df$flinders_street, paired = TRUE) # SC - FL

boot_stat_diff_paired <- function(d, idx){
  dd <- d[idx, , drop = FALSE]
  mean(dd[,1] - dd[,2])                 
}

boot_pair <- function(x, y, B = 5000, conf = 0.95){
  b  <- boot(data = cbind(x, y), statistic = boot_stat_diff_paired, R = B)
  ci <- boot.ci(b, conf = conf, type = "perc")
  tibble(
    est_diff = b$t0,
    se_boot  = sd(b$t),
    lo_perc  = unname(ci$percent[4]),
    hi_perc  = unname(ci$percent[5]))
}

paired_boot_table <- bind_rows(
  boot_pair(pedestrian_df$qv_melbourne,    pedestrian_df$southern_cross)  |> dplyr::mutate(contrast = "QV - SC"),
  boot_pair(pedestrian_df$qv_melbourne,    pedestrian_df$flinders_street) |> dplyr::mutate(contrast = "QV - FL"),
  boot_pair(pedestrian_df$southern_cross,  pedestrian_df$flinders_street) |> dplyr::mutate(contrast = "SC - FL")) |>
  relocate(contrast)
paired_boot_table
```

## task 2

### appraoch 1

```{r}
pedestrian_long %>%
  group_by(crossing) %>%
  summarise(q90 = quantile(count, 0.9))

```

```{r}

# function to calculate 90th percentile
q90_fn <- function(data, i) quantile(data[i], 0.9)

# example for Flinders
fl_boot <- boot(pedestrian_df$flinders_street, q90_fn, R = 1000)
ci_fl <- boot.ci(fl_boot, type = "perc")
round(ci_fl$percent[4:5], 2)

# Southern Cross
sc_boot <- boot(pedestrian_df$southern_cross, q90_fn, R = 1000)
ci_sc <- boot.ci(sc_boot, type = "perc")
round(ci_sc$percent[4:5], 2)


# QV
qv_boot <- boot(pedestrian_df$qv, q90_fn, R = 1000)
ci_qv <- boot.ci(qv_boot, type = "perc")
round(ci_qv$percent[4:5], 2)


```


